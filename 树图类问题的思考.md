## ç›´å¾„çš„æ€§è´¨

å¯¹äºæ ‘ä¸ŠåŠ¨æ€ç»´æŠ¤ç›´å¾„ï¼Œç±»ä¼¼[æ‰è¿·è—](https://www.luogu.com.cn/problem/P2056)ï¼ŒèŠ‚ç‚¹å­˜åœ¨æœ‰æ•ˆæœŸï¼Œå¯¹äºä¸€ä¸ªé›†åˆ $S$ å’Œåªæœ‰ä¸€ä¸ªç‚¹çš„é›†åˆ $\{ğ‘ƒ\}$ã€‚è‹¥é›†åˆ $S$ çš„ç›´å¾„ä¸º $(ğ‘ˆ,ğ‘‰)$ã€‚åˆ™ç‚¹é›† $ğ‘†âˆ©\{ğ‘ƒ\}$ çš„ç›´å¾„åªå¯èƒ½ä¸º $(ğ‘ˆ,ğ‘‰)$,$(U,P)$ æˆ– $(ğ‘‰,ğ‘ƒ)$ï¼Œæ•…åœ¨åŠ å…¥ç‚¹æ—¶å¯ä»¥ç”¨æœ€å¤šä¸¤æ¬¡$lca$,æ›´æ–°ç›´å¾„,ç›´å¾„ä¸º $len = dep[rt1] + dep[rt2] - 2*dep[lca(rt1,rt2)]$

## å¯å‘å¼åˆå¹¶

å¯¹äºç»´æŠ¤çš„ä¿¡æ¯$info$
ç¬¬ä¸€æ¬¡å…ˆéå†æ‰€æœ‰ **è½»å„¿å­** ,ç›´æ¥æ±‚è§£ä¸ç»´æŠ¤$info$
ç¬¬äºŒæ¬¡éå†é‡å„¿å­,æ±‚è§£çš„åŒæ—¶ä¿®æ”¹$info$
ç¬¬ä¸‰æ¬¡å†æ¬¡éå†æ‰€æœ‰ **è½»å„¿å­** , ä¿®æ”¹(æ¸…ç©º)$info$

```cpp
mson[0] = 1;// æ­¤å¤„ä¸ºäº†åˆ¤åˆ«å¯¹è½»å„¿å­æ¸…é™¤,ä¸ä½¿ç”¨é¢å¤–å˜é‡,è€Œæ˜¯æ¯”è¾ƒçˆ¶äº²çš„é‡å„¿å­æ˜¯ä¸æ˜¯è‡ªå·±,æ•…è®¾ç½®0çš„é‡å„¿å­ä¸º1
ll ans = 0;
auto dfs3 = [&](auto self, ll u, ll f) -> void {
    // ä¼˜å…ˆè½»å„¿å­
    for (int i = h[u]; ~i; i = e[i].next) {
        ll v = e[i].to;
        if (v != f && mson[u] != v) {
            self(self, v, u);
        }
    }
    // ç„¶åå†é‡å„¿å­
    if (mson[u]) {
        self(self, mson[u], u);
    }
    // æ­£å¸¸æ±‚è§£
    repi(i, dfn[u], dfn[u] + siz[u]) {
        // é‡åˆ°é‡å„¿å­,è·³è¿‡è¯¥å­æ ‘
        if (i == dfn[mson[u]]) {
            i += siz[mson[u]];
            if (i >= dfn[u] + siz[u]) {
                break;
            }
        }
        /*
        	æ›´æ–°æ ‘çŠ¶æ•°ç»„/çº¿æ®µæ ‘/æ•°ç»„,æ±‚è§£
        */
    }
    /*
    	// å¯¹äºæœ€é•¿/å¤§è·¯å¾„ç±»è§£æ³•æ›´é€‚åˆä»¥å­æ ‘ä¸ºå•ä½æ›´æ–°
    	for (int i = h[u]; ~i; i = e[i].next) {
            ll v = e[i].to;
            if (v != f && v != mson[u]) {
                for (int j = dfn[v]; j < dfn[v] + siz[v]; j++) {
                    // é€šè¿‡å…¶ä»–å­æ ‘çš„è´¡çŒ®æ›´æ–°ç­”æ¡ˆ
                }
                for (int j = dfn[v]; j < dfn[v] + siz[v]; j++) {
                    // åŠ å…¥æ­¤æ ‘çš„è´¡çŒ®
                }
            }
        }
        // è®°å¾—å¯¹ u æœ¬èº«æ›´æ–°ç­”æ¡ˆ
    */
    res[u] += tot;
    // æ¸…ç©ºè½»å„¿å­
    if (mson[f] != u) {
        ans = 0;
        repi(i, dfn[u], dfn[u] + siz[u]) {
            /*
                æ¸…ç©ºè®°å½•çš„æ•°æ®ç»“æ„
            */
        }
    }
};
```

## çº¿æ®µæ ‘åˆ†æ²»

**çº¿æ®µæ ‘åˆ†æ²»**å¤šæ•°æƒ…å†µä¼¼ä¹æ˜¯å’Œ**å¯æ’¤å›å¹¶æŸ¥é›†**ä¸€èµ·
å¥—è·¯ç”šè‡³å¤§å¤šä¸ºçº¿æ®µæ ‘å­˜å‚¨**è¾¹**çš„**æœ‰æ•ˆæœŸ**ï¼Œå³ä»¥**æ—¶é—´/è·ç¦»**ä½œä¸ºçº¿æ®µæ ‘çš„èŒƒå›´ï¼Œä»¥æ¨¡æ‹Ÿçº¿æ®µæ ‘éå†çš„å½¢å¼,å‡å°‘å»ºè¾¹/æ›´æ–°çš„å¤æ‚åº¦ï¼Œæ›´æ–°å¯æ’¤å›å¹¶æŸ¥é›†/ç­”æ¡ˆ.

```cpp
auto dfs = [&](auto self, ll p) -> void {
        ll siz = dsu.limit;// è®°å½•æ­¤æ—¶å¤§å°ï¼Œä»¥ä¿è¯å›æ»š
        for (auto v : seg.tr[p].dir) {// å¹¶å…¥æ­¤æ—¶æœ‰æ•ˆçš„è¾¹ï¼Œæœ‰æ•ˆèŒƒå›´ [tr[p].l,tr[p].r]
            auto [x, y] = ee[v];
            dsu.merge(x, y);
            /*
            	è®¡ç®—ç­”æ¡ˆè´¡çŒ®
            */
        }
        if (seg.tr[p].l != seg.tr[p].r) {
            self(self, p << 1);
            self(self, p << 1 | 1);
        }
    	// dsu.roll_back(dsu.limit - siz);
        while (dsu.limit > siz) {// å›æ»šiåªåœ¨ [tr[p].l,tr[p].r]æœ‰æ•ˆçš„è¾¹
            Pa res;
            ll x = dsu.stk.top();
            dsu.stk.pop();
            dsu.limit--;
            /*
            	å›æ»šè´¡çŒ®
            */
            dsu.siz[dsu.f[x]] -= dsu.siz[x];
            dsu.f[x] = x;
        }
    };
```

è€ƒè™‘å¯¹æŸ¥è¯¢æ¡ä»¶æˆ–èŒƒå›´è¿›è¡Œå»ºæ ‘ï¼Œ[è¿é€šå›¾](https://www.luogu.com.cn/problem/P5227) å°±æ˜¯è€ƒè™‘å¯¹æŸ¥è¯¢æ•°é‡è¿›è¡Œå»ºæ ‘ï¼Œè€ƒè™‘å¯¹è¾¹çš„æœ‰æ•ˆèŒƒå›´å°±æ˜¯$update$  
è€Œ [Unique Occurrences](https://codeforces.com/problemset/problem/1681/F) ä¸­ï¼Œæ˜¯æŸ¥è¯¢ä»…å‡ºç°**ä¸€æ¬¡çš„è¾¹æƒ**çš„è·¯å¾„æ•°ï¼Œé‚£ä¹ˆå¯ä»¥ä»¥æ€»çš„**è¾¹æƒèŒƒå›´**å»ºæ ‘ï¼Œå°†è¾¹æ”¾åœ¨é™¤äº†ä»–ä»¥å¤–çš„è¾¹æƒèŠ‚ç‚¹ä¸Šï¼Œåˆ°å¶èŠ‚ç‚¹éƒ¨åˆ†æ—¶ï¼Œåªè¦éå†è¯¥æƒå€¼è¾¹ä¸¤ç«¯**è¿é€šå—**çš„ç§¯å³å¯ã€‚
åœ¨$RMQ$â€‹ç±»å‹çš„é¢˜ç›®([æ´ç©´å‹˜æ¢](https://www.luogu.com.cn/problem/P2147)ã€[éƒ¨è½å†²çª](https://www.luogu.com.cn/problem/P3950))ä¸­ä¹Ÿå¯ä»¥å¯¹æŸ¥è¯¢**æ—¶é—´è½´**è¿›è¡Œå»ºæ ‘ï¼Œä»¥**è¾¹çš„æœ‰æ•ˆæœŸ**è¿›è¡Œæ›´æ–°ã€‚



## äºŒç»´åæ ‡ç³»è®¡æ•°

å¯¹äºäºŒç»´åæ ‡ç³»çš„**ç‚¹å¯¹**è´¡çŒ®å¤„ç†[Extending Set of Points](https://codeforces.com/problemset/problem/1140/F)ï¼Œå¯ä»¥å°†ç‚¹å¯¹ $(x,y)$ å¤„ç†æˆ $x -> y + n$ çš„è¾¹ï¼Œæ­¤æ—¶ï¼Œè¿™ä¸ªåæ ‡ç³»çš„å˜æˆäº†ä¸€å¼ äºŒåˆ†å›¾ï¼Œé‚£ä¹ˆä»–ä»¬çš„è´¡çŒ®å…³ç³»å˜æˆäº† **å·¦å­å›¾å’Œå³å­å›¾çš„ç§¯** ,å³éœ€è¦ä»¥**å¸¦æƒ** $DSU$ çš„å½¢å¼,æ·»åŠ ä¸¤ä¸ª $siz$ æ•°ç»„è®°å½•**å·¦å­å›¾**å’Œ**å³å­å›¾** ,æ³¨æ„å¯¹äºå·¦å­å›¾éƒ¨åˆ†çš„ç‚¹ $siz_{å³å­å›¾} = 0$ , åä¹‹åŒç†.

è®¾ç‚¹é›† $\mathbf{S}=\{ (1,2),(2,2),(2,4),(1,4) \}$,èŒƒå›´ä¸º $5$x$5$
![åæ ‡ç³»è½¬æ¢](https://raw.githubusercontent.com/ManInM00N/Pics/main/%E6%88%AA%E5%9B%BE%202024-07-24%2015-14-31.png)

```cpp
bool merge(int x, int y){
    x = find(x);
    y = find(y);
    if (x == y)
        return false;
    if (siz[x] < siz[y])
        std::swap(x,y);
    ans-=siz1[x] * siz2[x] + siz1[y] *siz2[y];
    stk.push({y,siz[x]});
    siz[x] += siz[x]==siz[y];
    siz1[x] += siz1[y];
    siz2[x]+=siz2[y];
    ans +=siz1[x]*siz2[x];
    f[y] = x;
    limit++;
    return true;
}
ll roll_back(ll req = 1e9){
    while (!stk.empty()&&req>0){
        auto [x,_] = stk.top();
        stk.pop();
        limit--;
        req--;
        siz[f[x]] = _;
        siz1[f[x]]-=siz1[x];
        siz2[f[x]]-=siz2[x];
        f[x] = x;
    }
    return limit;
}
```

### æ ‡è®°æ°¸ä¹…åŒ–

è€Œåœ¨é‚£äº›éœ€è¦**æ ‡è®°æœ‰æ•ˆç‚¹é›†**çš„é¢˜ç›®ä¸­,[Communication Towers](https://vjudge.net/problem/CodeForces-1814F) éœ€è¦è¾“å‡ºåœ¨æœ‰æ•ˆèŒƒå›´å†… $1$ å¯ä»¥åˆ°è¾¾çš„ç‚¹é›†,æ­¤æ—¶æˆ‘ä»¬å¯ä»¥è®¾ç½®ä¸€ä¸ªå¤–éƒ¨$tag$æ•°ç»„,ç”¨äºä¼ é€’ç­”æ¡ˆ,å½“$merge$çš„ä¸€ä¸ªå€¼å¯ä»¥åˆ°è¾¾$1$,é‚£ä¹ˆå¯¹ä»–çš„çˆ¶äº²æ ‡è®°,åœ¨$roll\_back$çš„è¿‡ç¨‹ä¸­ä¼ é€’æ ‡è®°,$merge$çš„è¿‡ç¨‹ä¸­è½¬ç§»æ ‡è®°,$tag>0$æ—¶ä¸ºæœ‰æ•ˆ.

```cpp
bool merge(int x, int y){
    x = find(x);
    y = find(y);
    if (x == y)
        return false;
    if (siz[x] < siz[y])
        std::swap(x,y);
    siz[x] += siz[y];
    f[y] = x;
    tag[y]-=tag[x];
    limit++;
    stk.push(y);
    return true;
}

ll roll_back(ll req = 1e9){
    while (!stk.empty()&&req>0){
        ll x = stk.top();
        stk.pop();
        limit--;
        req--;
        siz[f[x]]-=siz[x];
        tag[x] +=tag[f[x]];
        f[x] = x;
    }
    return limit;
}
auto dfs = [&](auto self, ll p) -> void {
    ll siz = dsu.limit;
    for (auto [x, y] : seg.tr[p].dir) {
        dsu.merge(x, y);
    }
    if (seg.tr[p].l != seg.tr[p].r) {
        self(self, p << 1);
        self(self, p << 1 | 1);
    } else {
        tag[dsu.find(1)]++;
    }
    dsu.roll_back(dsu.limit - siz);
};
```

# çº¿æ®µæ ‘åˆå¹¶

å¯¹äºä¿¡æ¯ç»´æŠ¤ä¸€å®šè¦**èŠ‚çœç©ºé—´**ï¼ŒåŠ¨æ€å¼€ç‚¹ææ˜“ $MLE$ ï¼ æ•…å¯ä»¥è€ƒè™‘åœ¨ $Merge$ çš„è¿‡ç¨‹ä¸­é‡‡ç”¨**å†…å­˜å›æ”¶** ([Dominant Indices](https://codeforces.com/problemset/problem/1009/F))çš„å½¢å¼ä¼˜åŒ–,å¯¹äºå€¼åŸŸåœ¨ $1e5$ å¤§å°å·¦å³,å¯ä»¥å¼€ $n*16$ çš„ç©ºé—´,å¯¹äº $5e5$ å¯ä»¥å¼€ $n*12$ 
åœ¨ $Merge$ çš„è¿‡ç¨‹ä¸­,è¢« $Merge$ æ‰çš„å­æ ‘ä¿¡æ¯å°†**å¤±æ•ˆ**,å› æ­¤åœ¨å¤„ç† $RMQ$ ç±»é—®é¢˜([Blood Cousins](https://codeforces.com/problemset/problem/208/E))æ—¶éœ€è¦å°†è¯¢é—®ç¦»çº¿è‡³ $dfs$ ä¸Š

```cpp
auto dfs2 = [&](auto self, ll u, ll f) -> void {
    for (int i = h[u]; ~i; i = e[i].next) {
        ll v = e[i].to;
        if (v == f)
            continue;
        self(self, v, u);
        seg.rt[u] = seg.Merge(seg.rt[u], seg.rt[v], 1, n + 1);// åˆå¹¶å­æ ‘
    }
    seg.rt[u] = seg.Modify(seg.rt[u], 1, n + 1, dep[u], dep[u], 1);
    // è¢«åˆå¹¶åå­æ ‘ä¿¡æ¯å¤±æ•ˆ,æ•…åœ¨è¯¥å­æ ‘ä¸Šå°†éœ€è¦çš„æŸ¥è¯¢å¤„ç†å¥½
    for (auto [x, y] : re[u]) {
        ans[x] = seg.Query(seg.rt[u], 1, n + 1, y, y).sum - 1;
    }
};

```

